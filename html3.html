@app.route('/get_data')
@login_required
@priviliges_check('ADMIN')
def get_data():
    # Получаем параметры сортировки и поиска из запроса
    sort_order = request.args.get('sort', 'DESC')  # По умолчанию сортировка по убыванию
    search_username = request.args.get('search', '')

    reg_requests, users, apps = pdbw.admin_console_get(sort_order, search_username)
    
    # Получаем запросы на доступ
    access_requests = []
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        query = """
            SELECT * FROM webplatform.reg_requests 
            WHERE req_type = 'ACCESS' AND status = 'A' 
            ORDER BY id ASC
        """
        if search_username:
            query = f"""
                SELECT * FROM webplatform.reg_requests 
                WHERE req_type = 'ACCESS' AND status = 'A' 
                AND username ILIKE '%{search_username}%'
                ORDER BY id ASC
            """
        
        cursor.execute(query)
        access_requests = cursor.fetchall()
        cursor.close()
        conn.close()
    except Exception as e:
        print(f"Error fetching access requests: {e}")

    return jsonify({
        'reg_requests': reg_requests,
        'users': users,
        'apps': apps,
        'access_requests': access_requests
    })
