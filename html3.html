import psycopg2
import configparser
from flask import jsonify, request
import json

def read_db_config():
    config = configparser.ConfigParser()
    config.read('config.ini')
    return {
        'host': config['POSTGRESQL']['host'],
        'port': config['POSTGRESQL']['port'],
        'database': config['POSTGRESQL']['database'],
        'user': config['POSTGRESQL']['user'],
        'password': config['POSTGRESQL']['password']
    }

def get_db_connection():
    db_config = read_db_config()
    return psycopg2.connect(**db_config)

@app.route('/get_apps_data')
@login_required
def get_apps_data():
    try:
        conn = get_db_connection()
        cursor = conn.cursor()
        
        # Получаем все приложения
        cursor.execute("SELECT id, app, alias FROM webplatform.apps ORDER BY id ASC")
        apps = [{'id': row[0], 'app': row[1], 'alias': row[2]} for row in cursor.fetchall()]
        
        # Получаем права пользователя
        cursor.execute("SELECT grants FROM webplatform.users WHERE username = %s", (current_user.username,))
        user_grants = cursor.fetchone()
        user_grants = user_grants[0] if user_grants else ''
        
        cursor.close()
        conn.close()
        
        return jsonify({
            'apps': apps,
            'user_grants': user_grants
        })
        
    except Exception as e:
        return jsonify({'error': str(e)}), 500

@app.route('/request_access', methods=['POST'])
@login_required
def request_access():
    try:
        data = request.get_json()
        requested_apps = data.get('apps', [])
        
        if not requested_apps:
            return jsonify({'success': False, 'error': 'No apps selected'})
        
        # Формируем строку с алиасами через точку с запятой
        apps_string = ';'.join(requested_apps)
        
        conn = get_db_connection()
        cursor = conn.cursor()
        
        # Вставляем запрос на доступ
        cursor.execute(
            "INSERT INTO webplatform.reg_requests (username, req_type, text, status) VALUES (%s, %s, %s, %s)",
            (current_user.username, 'ACCESS', apps_string, 'A')
        )
        
        conn.commit()
        cursor.close()
        conn.close()
        
        return jsonify({'success': True})
        
    except Exception as e:
        return jsonify({'success': False, 'error': str(e)}), 500
