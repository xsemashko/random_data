<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Токенизация.Статистика</title>
    <script src="/static/js/xlsx.full.min.js"></script>
    <style>
        /* Ваши стили остаются без изменений */
        /* ... */
    </style>
</head>
<body>
{% include 'toolbar_with_opacity.html' %}
    <div class="container">
        <h1>Токенизация Белкарт PAY. Статистика.</h1>
        <button class="export-button" onclick="exportToExcel()">Экспорт в Excel</button>
        
        <div class="tab-container">
            <div class="tabs">
                <button class="tablinks active" onclick="openTab(event, 'tab0')">Первая успешная попытка токенизации карты Банка</button>
                <button class="tablinks" onclick="openTab(event, 'tab2')">Первая успешная операция по новому токену Банка</button>
                <button class="tablinks" onclick="openTab(event, 'tab1')">Успешные операции по токенам Банка</button>
                <button class="tablinks" onclick="openTab(event, 'tab3')">Статистика по картам и пользователям</button>
            </div>
            
            <!-- Вкладки 0-2 остаются без изменений -->
            <!-- ... -->

            <!-- Новая вкладка -->
            <div id="tab3" class="tabcontent">
                <div class="table-container">
                    <table id="data-table3">
                        <thead>
                            <tr>
                                <th>Дата</th>
                                <th>Количество уникальных карт</th>
                                <th>Сберкарты</th>
                                <th>Белкарт</th>
                                <th>Visa</th>
                                <th>Mastercard</th>
                                <th>Количество уникальных пользователей</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in data3 %}
                            <tr data-date="{{ row[0] }}" 
                                data-year="{{ row[0].match(/\d{4}/)?.[0] || '0' }}" 
                                data-quarter="{{ row[0].includes('квартал') ? row[0].match(/\d/)?.[0] || '0' : Math.floor((parseInt(row[0].match(/-(\d{2})/)?.[1] || 0)/3)+1 }}" 
                                data-month="{{ row[0].match(/-(\d{2})/)?.[1] || '0' }}"
                                data-is-quarter="{{ row[0].includes('квартал') ? '1' : '0' }}"
                                data-is-total="{{ row[0] === 'За всё время' ? '1' : '0' }}">
                                <td>{{ row[0] }}</td>
                                <td>{{ row[1] }}</td>
                                <td>{{ row[2] }}</td>
                                <td>{{ row[3] }}</td>
                                <td>{{ row[4] }}</td>
                                <td>{{ row[5] }}</td>
                                <td>{{ row[6] }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        <p>Разработано командой процессинга. 2025.</p>
    </div>

    <div id="toast" class="toast">
        <span>В статистику включены только те карты, которые были активны на момент токенизации...</span>
        <button onclick="closeToast()">&times;</button>
    </div>

    <script>
        // Логика вкладок
        function openTab(evt, tabName) {
            const tabcontent = document.getElementsByClassName("tabcontent");
            const tablinks = document.getElementsByClassName("tablinks");

            for (let i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }

            for (let i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }

            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";

            if (tabName === 'tab3') {
                sortTable3();
            }
        }

        // Новая улучшенная функция сортировки
        function sortTable3() {
            const table = document.getElementById('data-table3');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));

            rows.sort((a, b) => {
                // "За всё время" всегда первое
                if (a.dataset.isTotal === '1') return -1;
                if (b.dataset.isTotal === '1') return 1;

                const yearA = parseInt(a.dataset.year);
                const yearB = parseInt(b.dataset.year);
                
                // Сначала сортируем по году (новые года вверху)
                if (yearA !== yearB) return yearB - yearA;

                const quarterA = parseInt(a.dataset.quarter);
                const quarterB = parseInt(b.dataset.quarter);
                const isQuarterA = a.dataset.isQuarter === '1';
                const isQuarterB = b.dataset.isQuarter === '1';
                const monthA = parseInt(a.dataset.month);
                const monthB = parseInt(b.dataset.month);

                // Если оба элемента относятся к одному кварталу
                if (quarterA === quarterB) {
                    // Квартальный итог должен быть перед месяцами
                    if (isQuarterA && !isQuarterB) return -1;
                    if (!isQuarterA && isQuarterB) return 1;
                    
                    // Если оба месяца - сортируем по убыванию
                    return monthB - monthA;
                }
                
                // Разные кварталы - сортируем по убыванию
                return quarterB - quarterA;
            });

            // Перестраиваем таблицу
            while (tbody.firstChild) {
                tbody.removeChild(tbody.firstChild);
            }

            rows.forEach(row => {
                tbody.appendChild(row);
            });
        }

        // Остальные функции остаются без изменений
        function formatHeaderText(text) {
            return text.charAt(0).toUpperCase() + text.slice(1).toLowerCase();
        }

        function exportToExcel() {
            const tables = [
                {node: document.getElementById('data-table'), name: '1-я успеш_попытка токен_карты'},
                {node: document.getElementById('data-table2'), name: '1-я успешая опер_по нов_токену'},
                {node: document.getElementById('data-table1'), name: 'Успешные операции по токенам'},
                {node: document.getElementById('data-table3'), name: 'Статистика по картам и пользователям'}
            ];

            const workbook = XLSX.utils.book_new();
            
            tables.forEach((table, index) => {
                const data = [];
                const rows = table.node.querySelectorAll("tr");
                
                rows.forEach((row) => {
                    const rowData = [];
                    const cells = row.querySelectorAll("th, td");
                    
                    cells.forEach((cell, cellIndex) => {
                        rowData.push(cell.innerText);
                    });
                    data.push(rowData);
                });
                
                const worksheet = XLSX.utils.aoa_to_sheet(data);
                XLSX.utils.book_append_sheet(workbook, worksheet, table.name);
            });

            const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
            saveAsExcelFile(excelBuffer);
        }

        function saveAsExcelFile(buffer) {
            const now = new Date();
            const formattedDate = [
                now.getFullYear(),
                String(now.getMonth() + 1).padStart(2, '0'),
                String(now.getDate()).padStart(2, '0'),
                String(now.getHours()).padStart(2, '0'),
                String(now.getMinutes()).padStart(2, '0')
            ].join('-');

            const blob = new Blob([buffer], { type: 'application/octet-stream' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Аналитика_по_токенизациям_${formattedDate}.xlsx`;
            link.click();
            
            setTimeout(() => {
                URL.revokeObjectURL(link.href);
            }, 100);
        }
        
        function closeToast() {
            const toast = document.getElementById("toast");
            toast.style.display = "none";
        }

        setTimeout(() => {
            closeToast();
        }, 15000);

        document.addEventListener('DOMContentLoaded', function() {
            if (document.getElementById('tab3').style.display === 'block') {
                sortTable3();
            }
        });
    </script>
</body>
</html>
