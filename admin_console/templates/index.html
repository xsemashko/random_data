<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="tabs">
        <button class="tablink" onclick="openTab(event, 'reg_requests')">Registration Requests</button>
        <button class="tablink" onclick="openTab(event, 'users')">Users</button>
    </div>

    <div id="reg_requests" class="tabcontent">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Request Type</th>
                    <th>Text</th>
                    <th>Status</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="reg_requests_body"></tbody>
        </table>
    </div>

    <div id="users" class="tabcontent">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>First Name</th>
                    <th>Last Name</th>
                    <th>Father's Name</th>
                    <th>Mail</th>
                    <th>Status</th>
                    <th>Last Login</th>
                    <th>Grants</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="users_body"></tbody>
        </table>
    </div>

    <script>
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }
            tablinks = document.getElementsByClassName("tablink");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }
            document.getElementById(tabName).style.display = "block";
            evt.currentTarget.className += " active";
        }

        function fetchData() {
            fetch('/get_data')
                .then(response => response.json())
                .then(data => {
                    const regRequestsBody = document.getElementById('reg_requests_body');
                    const usersBody = document.getElementById('users_body');

                    regRequestsBody.innerHTML = data.reg_requests.map(row => `
                        <tr>
                            <td>${row[0]}</td>
                            <td>${row[1]}</td>
                            <td>${row[2]}</td>
                            <td>${row[3]}</td>
                            <td><input type="text" value="${row[4]}" onchange="updateField('reg_requests', ${row[0]}, 'status', this.value)"></td>
                            <td>${row[5]}</td>
                            <td><button onclick="saveChanges('reg_requests', ${row[0]})">Save</button></td>
                        </tr>
                    `).join('');

                    usersBody.innerHTML = data.users.map(row => `
                        <tr>
                            <td>${row[0]}</td>
                            <td>${row[1]}</td>
                            <td>${row[2]}</td>
                            <td>${row[3]}</td>
                            <td>${row[4]}</td>
                            <td><input type="text" value="${row[5]}" onchange="updateField('users', ${row[0]}, 'mail', this.value)"></td>
                            <td><input type="text" value="${row[6]}" onchange="updateField('users', ${row[0]}, 'status', this.value)"></td>
                            <td>${row[7]}</td>
                            <td><input type="text" value="${row[8]}" onchange="updateField('users', ${row[0]}, 'grants', this.value)"></td>
                            <td><button onclick="saveChanges('users', ${row[0]})">Save</button></td>
                        </tr>
                    `).join('');
                });
        }

        function updateField(table, id, field, value) {
            if (!window.changes) window.changes = {};
            if (!window.changes[table]) window.changes[table] = {};
            if (!window.changes[table][id]) window.changes[table][id] = {};
            window.changes[table][id][field] = value;
        }

        function saveChanges(table, id) {
            const changes = window.changes?.[table]?.[id];
            if (!changes) return;

            fetch('/update_data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    table: table,
                    id: id,
                    ...changes
                })
            }).then(response => response.json())
              .then(data => {
                  if (data.success) {
                      alert('Changes saved successfully');
                      fetchData();
                  }
              });
        }

        document.addEventListener('DOMContentLoaded', function() {
            fetchData();
            document.getElementsByClassName('tablink')[0].click();
        });
    </script>
</body>
</html>
