{% extends "base.html" %}

{% block content %}
 
<link rel="stylesheet" type="text/css" href="/static/css/index.css">
<link rel="stylesheet" type="text/css" href="/static/css/index_background.css">

{% include 'toolbar.html' %}

  <form id="form{{ form_template }}">
    <!-- Кнопка приложений с обработчиком -->
    <div>
      <a id="app_button" href="#" onclick="showAppsModal(event)"><img id="app_logo" src="/static/store_icon.png"></a>
      <label for="app_button">Приложения</label>
    </div>
    
    <!-- Остальные кнопки остаются без изменений -->
    <div>
      <a id="app_button" href="{{ url_for('product_maximum') }}"><img id="app_logo" src="/static/pm_logo.png"></a>
      <label for="app_button">Продукты Максимум</label>
    </div>
    <!-- ... остальные приложения ... -->
  </form>

  <!-- Модальное окно для выбора приложений -->
  <div id="appsModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Доступ к приложениям</h2>
      <div id="appsList"></div>
      <button onclick="submitAccessRequest()">Запросить доступ</button>
    </div>
  </div>

  <!-- Стили для модального окна -->
  <style>
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      max-width: 600px;
      border-radius: 10px;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover {
      color: black;
    }

    .app-btn {
      padding: 10px;
      margin: 5px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .app-btn.available {
      background-color: black;
      color: white;
    }

    .app-btn.not-available {
      background-color: #ccc;
      color: black;
    }

    .app-btn.selected {
      border: 2px solid blue;
    }
  </style>

  <!-- JavaScript для работы с модальным окном -->
  <script>
    let selectedApps = [];

    function showAppsModal(event) {
      event.preventDefault();
      fetch('/get_apps_data')
        .then(response => response.json())
        .then(data => {
          displayApps(data.apps, data.user_grants);
          document.getElementById('appsModal').style.display = 'block';
        })
        .catch(error => console.error('Error:', error));
    }

    function displayApps(apps, userGrants) {
      const appsList = document.getElementById('appsList');
      appsList.innerHTML = '';
      selectedApps = [];

      const userHasAccess = userGrants.includes('ADMIN') ? 
        apps.map(app => app.alias) : 
        userGrants.split(';').filter(alias => alias);

      apps.forEach(app => {
        const isAvailable = userHasAccess.includes(app.alias) || userHasAccess.includes('ADMIN');
        const btn = document.createElement('button');
        btn.className = `app-btn ${isAvailable ? 'available' : 'not-available'}`;
        btn.textContent = app.app;
        btn.dataset.alias = app.alias;
        btn.dataset.available = isAvailable;
        
        if (!isAvailable) {
          btn.onclick = function() {
            this.classList.toggle('selected');
            const alias = this.dataset.alias;
            if (this.classList.contains('selected')) {
              selectedApps.push(alias);
            } else {
              selectedApps = selectedApps.filter(a => a !== alias);
            }
          };
        } else {
          btn.style.cursor = 'default';
        }

        appsList.appendChild(btn);
      });
    }

    function submitAccessRequest() {
      if (selectedApps.length === 0) {
        alert('Выберите хотя бы одно приложение для запроса доступа');
        return;
      }

      fetch('/request_access', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ apps: selectedApps })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert('Запрос на доступ отправлен успешно');
          document.getElementById('appsModal').style.display = 'none';
        } else {
          alert('Ошибка при отправке запроса: ' + data.error);
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Произошла ошибка при отправке запроса');
      });
    }

    // Закрытие модального окна
    document.querySelector('.close').onclick = function() {
      document.getElementById('appsModal').style.display = 'none';
    }

    window.onclick = function(event) {
      const modal = document.getElementById('appsModal');
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    }
  </script>
{% endblock %}
